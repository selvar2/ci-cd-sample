name: Multi-Branch CI/CD Pipeline

# Trigger conditions
on:
  push:
    branches:
      - main
      - test
      - dev
      - 'branch-*'
  pull_request:
    branches:
      - main
      - test
      - dev
      - 'branch-*'

# Environment variables
env:
  ARTIFACT_RETENTION_DAYS: 30
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # STAGE 1: DETECT & VALIDATE
  # Identify the active branch and validate the codebase
  # ============================================================================
  detect-branch:
    name: Detect Active Branch
    runs-on: ubuntu-latest
    
    outputs:
      branch: ${{ steps.detect.outputs.branch }}
      is-main: ${{ steps.detect.outputs.is-main }}
      is-test: ${{ steps.detect.outputs.is-test }}
      is-dev: ${{ steps.detect.outputs.is-dev }}
      is-feature: ${{ steps.detect.outputs.is-feature }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch analysis
      
      - name: Detect Branch
        id: detect
        run: |
          # Get the current branch name
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          
          # Detect branch type
          if [[ "${BRANCH}" == "main" ]]; then
            echo "is-main=true" >> $GITHUB_OUTPUT
            echo "is-test=false" >> $GITHUB_OUTPUT
            echo "is-dev=false" >> $GITHUB_OUTPUT
            echo "is-feature=false" >> $GITHUB_OUTPUT
            echo "ðŸ”´ Detected: MAIN (Production)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${BRANCH}" == "test" ]]; then
            echo "is-main=false" >> $GITHUB_OUTPUT
            echo "is-test=true" >> $GITHUB_OUTPUT
            echo "is-dev=false" >> $GITHUB_OUTPUT
            echo "is-feature=false" >> $GITHUB_OUTPUT
            echo "ðŸŸ  Detected: TEST (Staging)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${BRANCH}" == "dev" ]]; then
            echo "is-main=false" >> $GITHUB_OUTPUT
            echo "is-test=false" >> $GITHUB_OUTPUT
            echo "is-dev=true" >> $GITHUB_OUTPUT
            echo "is-feature=false" >> $GITHUB_OUTPUT
            echo "ðŸŸ¡ Detected: DEV (Development)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${BRANCH}" =~ ^branch- ]]; then
            echo "is-main=false" >> $GITHUB_OUTPUT
            echo "is-test=false" >> $GITHUB_OUTPUT
            echo "is-dev=false" >> $GITHUB_OUTPUT
            echo "is-feature=true" >> $GITHUB_OUTPUT
            echo "ðŸŸ¢ Detected: FEATURE (${BRANCH})" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 2: BUILD & VALIDATE
  # Compile and validate the HTML application
  # ============================================================================
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: detect-branch
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Create Build Directory
        run: mkdir -p build
      
      - name: Copy Application Files
        run: |
          cp -r src/* build/
          echo "âœ“ Application files copied to build directory"
          ls -la build/
      
      - name: Inject Branch Information
        run: |
          # Inject branch meta tag into HTML
          BRANCH="${{ needs.detect-branch.outputs.branch }}"
          sed -i "/<head>/a\\    <meta name=\"branch\" content=\"${BRANCH}\">" build/index.html
          sed -i "/<head>/a\\    <meta name=\"build-time\" content=\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\">" build/index.html
          sed -i "/<head>/a\\    <meta name=\"commit-sha\" content=\"${{ github.sha }}\">" build/index.html
          
          echo "âœ“ Branch information injected"
      
      - name: Validate HTML Structure
        run: |
          # Basic HTML validation
          echo "Validating HTML structure..."
          
          if grep -q "<!DOCTYPE html>" build/index.html; then
            echo "âœ“ DOCTYPE declaration present"
          else
            echo "âœ— Missing DOCTYPE declaration"
            exit 1
          fi
          
          if grep -q "<html" build/index.html; then
            echo "âœ“ HTML tag present"
          else
            echo "âœ— Missing HTML tag"
            exit 1
          fi
          
          if grep -q "<head>" build/index.html; then
            echo "âœ“ Head section present"
          else
            echo "âœ— Missing head section"
            exit 1
          fi
          
          if grep -q "<body>" build/index.html; then
            echo "âœ“ Body section present"
          else
            echo "âœ— Missing body section"
            exit 1
          fi
          
          if grep -q "app-title" build/index.html; then
            echo "âœ“ App title element present"
          else
            echo "âœ— Missing app title element"
            exit 1
          fi
          
          echo "âœ“ All HTML validations passed"
      
      - name: Validate CSS
        run: |
          echo "Validating CSS structure..."
          
          if [ -f build/styles.css ]; then
            if grep -q "body {" build/styles.css; then
              echo "âœ“ CSS contains body styles"
            else
              echo "âš  Warning: CSS may be incomplete"
            fi
            
            # Check for syntax errors (basic check)
            if tail -c 1 build/styles.css | grep -q .; then
              echo "âœ“ CSS file properly terminated"
            fi
          fi
      
      - name: Validate JavaScript
        run: |
          echo "Validating JavaScript structure..."
          
          if [ -f build/app.js ]; then
            # Check if the file is not empty
            if [ -s build/app.js ]; then
              echo "âœ“ JavaScript file contains code"
            else
              echo "âœ— JavaScript file is empty"
              exit 1
            fi
            
            # Check for syntax
            if node -c build/app.js 2>/dev/null; then
              echo "âœ“ JavaScript syntax is valid"
            else
              echo "âš  Warning: Could not fully validate JavaScript syntax"
            fi
          fi
      
      - name: Check for Branch Conflicts
        run: |
          # Prevent merging from incorrect branches
          BRANCH="${{ needs.detect-branch.outputs.branch }}"
          
          # Example: Prevent non-main commits from using production assets
          if [[ "${BRANCH}" != "main" ]] && grep -q "production" build/index.html; then
            echo "âš  Warning: Non-production branch contains production markers"
          fi
          
          echo "âœ“ Cross-branch conflict check passed"
      
      - name: Generate Build Report
        run: |
          {
            echo "## Build Report"
            echo ""
            echo "**Branch**: ${{ needs.detect-branch.outputs.branch }}"
            echo "**Commit**: ${{ github.sha }}"
            echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Build Artifacts"
            echo "\`\`\`"
            ls -lah build/
            echo "\`\`\`"
            echo ""
            echo "### File Sizes"
            echo "| File | Size |"
            echo "|------|------|"
            ls -lh build/ | awk 'NR>1 {print "| " $9 " | " $5 " |"}'
            echo ""
            echo "### Validation Summary"
            echo "- âœ“ HTML structure validated"
            echo "- âœ“ CSS structure validated"
            echo "- âœ“ JavaScript syntax validated"
            echo "- âœ“ No cross-branch conflicts detected"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ needs.detect-branch.outputs.branch }}
          path: build/
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  # ============================================================================
  # STAGE 3: TEST & QUALITY CHECKS
  # Run automated tests and quality checks
  # ============================================================================
  test:
    name: Run Tests & Quality Checks
    runs-on: ubuntu-latest
    needs: [detect-branch, build]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.detect-branch.outputs.branch }}
          path: build/
      
      - name: Lint HTML
        run: |
          echo "Running HTML linting..."
          
          # Simple linting checks
          ISSUES=0
          
          # Check for missing alt attributes in images
          if grep -r "<img" build/ | grep -v "alt=" > /dev/null; then
            echo "âš  Warning: Some images may be missing alt attributes"
            ((ISSUES++))
          else
            echo "âœ“ All images have alt attributes"
          fi
          
          # Check for proper heading hierarchy
          if grep -q "<h1" build/index.html; then
            echo "âœ“ H1 tag present"
          fi
          
          # Check for meta viewport
          if grep -q "viewport" build/index.html; then
            echo "âœ“ Viewport meta tag present"
          else
            echo "âš  Warning: Viewport meta tag missing"
            ((ISSUES++))
          fi
          
          if [ $ISSUES -eq 0 ]; then
            echo ""
            echo "âœ“ HTML linting passed with no critical issues"
          fi
      
      - name: Accessibility Checks
        run: |
          echo "Running accessibility checks..."
          
          # Check for lang attribute
          if grep -q '<html.*lang=' build/index.html; then
            echo "âœ“ HTML lang attribute present"
          else
            echo "âœ— Missing lang attribute in HTML"
          fi
          
          # Check for proper color contrast (basic)
          echo "âœ“ Accessibility checks completed"
      
      - name: Performance Check
        run: |
          echo "Running performance checks..."
          
          BUILD_SIZE=$(du -sh build | cut -f1)
          echo "Build size: ${BUILD_SIZE}"
          
          HTML_SIZE=$(wc -c < build/index.html)
          CSS_SIZE=$(wc -c < build/styles.css)
          JS_SIZE=$(wc -c < build/app.js)
          
          echo "- HTML: ${HTML_SIZE} bytes"
          echo "- CSS: ${CSS_SIZE} bytes"
          echo "- JS: ${JS_SIZE} bytes"
          
          # Warn if files are too large
          if [ "$HTML_SIZE" -gt 100000 ]; then
            echo "âš  Warning: HTML file is large (>100KB)"
          else
            echo "âœ“ HTML file size is optimal"
          fi
          
          if [ "$CSS_SIZE" -gt 100000 ]; then
            echo "âš  Warning: CSS file is large (>100KB)"
          else
            echo "âœ“ CSS file size is optimal"
          fi

  # ============================================================================
  # STAGE 4: DEPLOYMENT GATES & ENFORCEMENT
  # Enforce branch-specific deployment rules
  # ============================================================================
  deployment-gates:
    name: Check Deployment Gates
    runs-on: ubuntu-latest
    needs: [detect-branch, build, test]
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Enforce Branch Promotion Strategy
        run: |
          BRANCH="${{ needs.detect-branch.outputs.branch }}"
          EVENT_TYPE="${{ github.event_name }}"
          
          echo "## Deployment Gate Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          case "${BRANCH}" in
            main)
              echo "ðŸ”´ **Branch**: Production (main)" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Source**: test branch only" >> $GITHUB_STEP_SUMMARY
              echo "**Required Approvals**: 1 (Team Lead)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # In real scenario, check if the merge came from test branch
              if [[ "${EVENT_TYPE}" == "push" ]]; then
                echo "âœ“ Push to main branch detected" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            
            test)
              echo "ðŸŸ  **Branch**: Staging (test)" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Source**: dev branch only" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Target**: main branch" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ“ Ready for promotion to production" >> $GITHUB_STEP_SUMMARY
              ;;
            
            dev)
              echo "ðŸŸ¡ **Branch**: Development (dev)" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Source**: feature branches" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Target**: test branch" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ“ Ready for promotion to staging" >> $GITHUB_STEP_SUMMARY
              ;;
            
            branch-*)
              echo "ðŸŸ¢ **Branch**: Feature (${BRANCH})" >> $GITHUB_STEP_SUMMARY
              echo "**Promotion Target**: dev branch" >> $GITHUB_STEP_SUMMARY
              echo "**Status**: Development in progress" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ“ Feature branch isolated and independent" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

  # ============================================================================
  # STAGE 5: DEPLOY (Conditional)
  # Deploy build artifacts based on branch
  # ============================================================================
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [detect-branch, build, test, deployment-gates]
    if: github.event_name == 'push'
    
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.detect-branch.outputs.branch }}
          path: build/
      
      - name: Prepare Deployment
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ needs.detect-branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Deploy to Dev Environment
        if: needs.detect-branch.outputs.is-dev == 'true'
        run: |
          echo "ðŸŸ¡ Deploying to Development environment..."
          echo "Location: /var/www/dev/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # In a real scenario:
          # - scp build/* user@dev-server:/var/www/dev/
          # - ssh user@dev-server 'systemctl restart app'
          
          echo "Deployment would execute:"
          echo "  scp -r build/* user@dev-server:/var/www/dev/"
          echo "  ssh user@dev-server 'systemctl restart app'"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Dev deployment prepared" >> $GITHUB_STEP_SUMMARY
      
      - name: Deploy to Test Environment
        if: needs.detect-branch.outputs.is-test == 'true'
        run: |
          echo "ðŸŸ  Deploying to Test (Staging) environment..."
          echo "Location: /var/www/test/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # In a real scenario:
          # - scp build/* user@test-server:/var/www/test/
          # - ssh user@test-server 'systemctl restart app'
          # - Run smoke tests
          
          echo "Deployment would execute:"
          echo "  scp -r build/* user@test-server:/var/www/test/"
          echo "  Run smoke tests"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Test deployment prepared" >> $GITHUB_STEP_SUMMARY
      
      - name: Deploy to Production
        if: needs.detect-branch.outputs.is-main == 'true'
        run: |
          echo "ðŸ”´ Deploying to Production environment..."
          echo "Location: /var/www/html/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # In a real scenario, require additional manual approval or credentials
          # - Backup current production
          # - scp build/* user@prod-server:/var/www/html/
          # - Health checks
          # - Rollback capability
          
          echo "Deployment would execute:"
          echo "  Backup current production"
          echo "  scp -r build/* user@prod-server:/var/www/html/"
          echo "  Run health checks"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Production deployment prepared" >> $GITHUB_STEP_SUMMARY
      
      - name: Deploy Feature Branch
        if: needs.detect-branch.outputs.is-feature == 'true'
        run: |
          BRANCH="${{ needs.detect-branch.outputs.branch }}"
          echo "ðŸŸ¢ Deploying feature branch to isolated environment..."
          echo "Location: /var/www/features/${BRANCH}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # In a real scenario:
          # - Create isolated environment for each feature
          # - Deploy to unique URL for testing
          
          echo "Deployment would execute:"
          echo "  mkdir -p /var/www/features/${BRANCH}"
          echo "  scp -r build/* user@server:/var/www/features/${BRANCH}/"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Feature branch deployment prepared" >> $GITHUB_STEP_SUMMARY
      
      - name: Post-Deployment Verification
        run: |
          echo "Verifying deployment..."
          
          if [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "âœ“ Build artifacts verified"
          else
            echo "âœ— Build artifacts missing"
            exit 1
          fi
      
      - name: Create Deployment Report
        run: |
          {
            echo "## Deployment Report"
            echo ""
            echo "- **Branch**: ${{ needs.detect-branch.outputs.branch }}"
            echo "- **Status**: âœ“ Success"
            echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Commit**: ${{ github.sha }}"
            echo ""
            echo "Artifacts deployed and ready for access."
          } >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 6: NOTIFICATION & SUMMARY
  # Summarize pipeline execution
  # ============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [detect-branch, build, test, deployment-gates, deploy]
    if: always()
    
    steps:
      - name: Generate Final Report
        run: |
          {
            echo "# CI/CD Pipeline Complete"
            echo ""
            echo "## Status Summary"
            echo ""
            echo "| Stage | Status |"
            echo "|-------|--------|"
            echo "| Detect Branch | âœ“ |"
            echo "| Build & Validate | âœ“ |"
            echo "| Tests & Quality | âœ“ |"
            echo "| Deployment Gates | âœ“ |"
            echo "| Deploy | âœ“ |"
            echo ""
            echo "## Branch Information"
            echo "- **Active Branch**: ${{ needs.detect-branch.outputs.branch }}"
            echo "- **Event**: ${{ github.event_name }}"
            echo "- **Triggering Commit**: ${{ github.sha }}"
            echo "- **Author**: ${{ github.actor }}"
            echo ""
            echo "## Next Steps"
            echo ""
            if [[ "${{ needs.detect-branch.outputs.branch }}" == "dev" ]]; then
              echo "1. Test changes in development environment"
              echo "2. Create pull request to merge into test branch"
              echo "3. Code review required before test deployment"
            elif [[ "${{ needs.detect-branch.outputs.branch }}" == "test" ]]; then
              echo "1. Verify changes in test (staging) environment"
              echo "2. Run integration tests"
              echo "3. Create pull request to merge into main for production release"
            elif [[ "${{ needs.detect-branch.outputs.branch }}" == "main" ]]; then
              echo "1. Changes deployed to production"
              echo "2. Monitor application performance"
              echo "3. Verify end-user access"
            elif [[ "${{ needs.detect-branch.outputs.branch }}" =~ ^branch- ]]; then
              echo "1. Continue feature development"
              echo "2. Push additional commits to feature branch"
              echo "3. When complete, create pull request to dev branch"
            fi
          } >> $GITHUB_STEP_SUMMARY
